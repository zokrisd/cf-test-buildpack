#!/usr/bin/env bash

echo "Running cache test..."

BUILD_DIR=$1
CACHE_DIR=$2
BUILD_PACK_DIR=$(dirname $(dirname $0))

export BUILD_DIR
export CACHE_DIR

curl -o $BUILD_DIR/mongo.tgz https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-ubuntu1404-3.4.3.tgz

cd $BUILD_DIR
pwd

mkdir -p mongodb-data

tar xvf mongo.tgz
#find . -ls

echo "==================================="
echo "Creating start script into $BUILD_DIR/start.sh"

cat > "$BUILD_DIR/start.sh" <<EOF
#!/bin/bash
#
# Start mongodb server
#
echo "Starting Mongo Server"
cd /home/vcap/app/mongodb-linux-x86_64-ubuntu1404-3.4.3
pwd

./bin/mongod --dbpath ../mongodb-data > /dev/null
EOF
chmod 755 "$BUILD_DIR/start.sh"

sleep 5

echo "==================================="
cat "$BUILD_DIR/start.sh"

echo "Leaving"

